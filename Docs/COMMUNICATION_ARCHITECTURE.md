# Office Robot Service - 통신 아키텍처 (v1.1)

이 문서는 Office Robot Service 시스템을 구성하는 각 컴포넌트(메인 서버, AI 서버, 로봇, 사용자 앱) 간의 통신 방식, 프로토콜, 그리고 데이터 흐름을 상세히 기술합니다.

---

## 1. 통신 구조 개요

본 시스템의 통신은 목적에 따라 **제어(Control)**, **데이터(Data)**, **추론(Inference)**, **서비스(Service)**의 4개 영역으로 명확히 분리됩니다.

```
+-----------------+      +------------------+      +--------------------+
|   User Apps     |      |                  |      |   AI Server        |
| (Admin/Employee)|<====>|   Main Server    |<====>| (GPU, Python)      |
| [Service Plane] |      | (FastAPI, FMS)   |      | [Inference Plane]  |
+-----------------+      |                  |      | (gRPC Stream)      |
                         +--------+---------+      +---------^----------+
                                  |                          |
        [Control Plane]           |                          | [Data Plane]
        (ROS Bridge)              |                          | (UDP Video Stream)
                                  |                          |
                         +--------v---------+                |
                         |                  |----------------+
                         |   Robot (ROS 2)  |
                         | (Jazzy)          |
                         +------------------+
```

---

## 2. 영역별 상세 명세

### A. 제어 영역 (Control Plane): 메인 서버 <-> 로봇

-   **목적**: 로봇의 동작을 제어하고 상태를 모니터링하는, 신뢰성이 가장 중요한 통신.
-   **방식**: **ROS 브리지 (WebSocket over TCP)**
-   **데이터 흐름**:
    -   `서버 -> 로봇`: 작업 할당, 긴급 정지 등 `Action Command Sequence` (JSON) 전송.
    -   `로봇 -> 서버`: 위치, 배터리, 현재 상태 등 `Robot Status` (JSON)를 주기적으로 보고.

### B. 데이터 영역 (Data Plane): 로봇 -> AI 서버

-   **목적**: AI 추론에 사용될 로봇의 카메라 영상을 최소 지연으로 실시간 전송.
-   **방식**: **Raw UDP**
-   **중요**: **이미지는 로봇에서 AI 서버로만 직접 전송**되며, 메인 서버로는 전달되지 않습니다. 이는 메인 서버의 부하를 줄이고 실시간성을 극대화하기 위함입니다.
-   **데이터 흐름**:
    -   로봇의 카메라 노드가 촬영한 영상 프레임을 인코딩하여 AI 서버의 지정된 포트(예: 54321)로 직접 스트리밍합니다.

### C. 추론 영역 (Inference Plane): 메인 서버 <-> AI 서버

-   **목적**: 메인 서버가 AI 서버의 추론 결과를 수신하여 로봇에게 적절한 명령을 내리기 위함.
-   **방식**: **gRPC (HTTP/2) - Unary + Server-side Streaming**
-   **데이터 흐름**:
    -   **구독(Streaming)**: 메인 서버가 AI 서버에 스트림 연결을 요청하면, AI 서버는 로봇으로부터 받은 영상을 분석한 결과를 실시간으로 Push합니다.
    -   **명시적 요청(Unary)**: 메인 서버가 특정 시점에 필요한 추론 결과를 `image_id`를 통해 직접 요청하고 응답을 받습니다.

### D. 서비스 영역 (Service Plane): 사용자 앱 <-> 메인 서버

-   **목적**: 사용자가 브라우저를 통해 시스템과 상호작용하고 관리자가 실시간으로 로봇 상태를 모니터링합니다.
-   **방식**: **웹 (HTTP/HTTPS) + REST API + WebSocket**

---

## 3. 통신 방식 요약 테이블

| **구간 (From <-> To)**   | **프로토콜**                                    | **주요 데이터**                                    | **선정 이유**                                     |
| ------------------------ | ----------------------------------------------- | -------------------------------------------------- | ------------------------------------------------- |
| 로봇 내부 노드 간        | ROS 2 (DDS)                                     | 센서 데이터, 로컬 제어 명령                        | 실시간, 고성능 내부 통신                          |
| 메인 서버 <-> 로봇       | ROS 브리지 (WebSocket/TCP)                      | 작업 명령, 로봇 상태 (JSON)                        | 신뢰성 보장, 표준화, 개발 용이성                  |
| 로봇 -> AI 서버          | Raw UDP                                         | H.264/MJPEG 영상 스트림                            | 지연 시간 최소화 (메인 서버 경유 안 함)           |
| 메인 서버 <-> AI 서버    | gRPC (HTTP/2)                                   | 실시간 추론 결과 (Streaming), 개별 요청 (Unary)    | 실시간 Push 가능, 성능, 타입 안전성               |
| 사용자 앱 <-> 메인 서버  | 웹 (HTTP/HTTPS) + REST API + WebSocket          | UI, API 요청/응답 (HTML, JSON), 실시간 상태        | 웹 표준 기술 사용, 범용성 및 실시간성             |