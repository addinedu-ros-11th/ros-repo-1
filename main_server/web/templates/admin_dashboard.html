<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ê´€ì œ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="../static/admin_style.css">
    <style>
        /* [ì§€ë„ ë° ë“œë¡œì‰ ê´€ë ¨ ì¶”ê°€ ìŠ¤íƒ€ì¼ ë³µêµ¬] */
        #map-container {
            position: relative;
            width: 800px;
            height: 600px;
            background-color: white;
            border: 2px solid #333;
            margin-top: 20px;
            overflow: hidden;
            background-image: 
                linear-gradient(#eee 1px, transparent 1px),
                linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 40px 40px;
            cursor: crosshair;
        }
        .btn-zone-setup {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            padding: 8px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .temp-rect {
            position: absolute;
            border: 2px dashed #e74c3c;
            background: rgba(231, 76, 60, 0.2);
            pointer-events: none;
        }
        .no-go-zone {
            position: absolute;
            background: rgba(231, 76, 60, 0.4);
            border: 2px solid #e74c3c;
            color: #c0392b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ê´€ë¦¬ì ë©”ë‰´</h2>
        <ul class="sidebar-menu">
            <li id="menu-robot-mgmt" onclick="showTab('robot-mgmt')">ğŸ¤– ë¡œë´‡ ê´€ë¦¬</li>
            <li id="menu-office-mgmt" onclick="showTab('office-mgmt')">ğŸ¢ ì‚¬ë¬´ì‹¤ ê´€ë¦¬</li>
            <li id="menu-visitor-res" onclick="showTab('visitor-res')">ğŸ“… ë°©ë¬¸ê° ì˜ˆì•½ í˜„í™©</li>
            <li id="menu-sys-logs" onclick="showTab('sys-logs')">ğŸ“œ ì‹œìŠ¤í…œ ë™ì‘ ë¡œê·¸</li>
        </ul>
        <a href="javascript:void(0);" class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <div class="main-content">
        <div id="robot-mgmt" class="tab-content">
            <h1 style="margin-bottom: 15px;">ğŸ¤– ë¡œë´‡ ì‹¤ì‹œê°„ ê´€ì œ</h1>

            <div style="position: relative; width: fit-content;">
                <button id="setup-btn" onclick="toggleZoneSetup()" 
                        style="position: absolute; bottom: 100%; right: 0; margin-bottom: 5px; 
                            padding: 6px 12px; font-size: 0.85rem; font-weight: bold; 
                            background: #e74c3c; color: white; border: none; border-radius: 4px; 
                            cursor: pointer; z-index: 11;">
                    ğŸš« ê¸ˆì§€êµ¬ì—­ ì„¤ì •: OFF
                </button>

                <div id="map-container" 
                    onmousedown="startDraw(event)" 
                    onmousemove="doDraw(event)" 
                    onmouseup="endDraw(event)" 
                    oncontextmenu="return false;" 
                    style="margin-top: 0;"> 
                    <div id="map-inner"></div>
                </div>
            </div>
            
            <div class="zone-management" style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">ğŸ“‹ ì„¤ì •ëœ ê¸ˆì§€êµ¬ì—­ ë¦¬ìŠ¤íŠ¸</h3>
                <div id="zone-list-container"></div>
            </div>
        </div>

        <div id="office-mgmt" class="tab-content">
            <h2>ğŸ¢ ì‚¬ë¬´ì‹¤ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>
            <div class="office-grid">
                <div class="office-section">
                    <h3>ğŸ“… íšŒì˜ì‹¤ í˜„í™©</h3>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>íšŒì˜ì‹¤</th>
                                <th>ìƒíƒœ</th>
                                <th>ì˜ˆì•½ì</th>
                                <th>ì˜ˆì•½ì‹œê°„</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ì œ 1 íšŒì˜ì‹¤</td>
                                <td><span class="status-indicator status-on"></span></td>
                                <td>ê¹€ì² ìˆ˜</td>
                                <td>14:00 - 16:00</td>
                            </tr>
                            <tr>
                                <td>ì œ 2 íšŒì˜ì‹¤</td>
                                <td><span class="status-indicator status-off"></span></td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="office-section">
                    <h3>ğŸ¿ ê°„ì‹ í˜„í™©</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>í’ˆëª©ëª…</th><th>ìˆ˜ëŸ‰</th><th>ìƒíƒœ</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>ìº¡ìŠ ì»¤í”¼</td><td>45ê°œ</td><td>ì¶©ë¶„</td></tr>
                            <tr><td>ìƒìˆ˜</td><td>5ê°œ</td><td><span style="color:red">ë¶€ì¡±</span></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="visitor-res" class="tab-content">
            <h2>ğŸ“… ë°©ë¬¸ê° ì˜ˆì•½ í˜„í™©</h2>
            <table class="data-table">
                <thead>
                    <tr><th>ë°©ë¬¸ë‚ ì§œ</th><th>ë°©ë¬¸ì‹œê°„</th><th>ë‹´ë‹¹ì</th><th>ë°©ë¬¸ê°</th></tr>
                </thead>
                <tbody id="visitor-list"></tbody>
            </table>
        </div>

        <div id="sys-logs" class="tab-content">
            <h2>ğŸ“œ ì‹œìŠ¤í…œ ë™ì‘ ë¡œê·¸</h2>
            <table class="data-table">
                <thead>
                    <tr><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ë¡œë´‡ëª…</th><th>ìƒíƒœ</th></tr>
                </thead>
                <tbody id="log-list"></tbody>
            </table>
        </div>
    </div>

    <script>
        /* [ì „ì—­ ìƒíƒœ ê´€ë¦¬] */
        let currentRobots = []; // ì‹¤ì‹œê°„ ë¡œë´‡ ìœ„ì¹˜ ì €ì¥ (ì¶©ëŒ ê²€ì‚¬ìš©)
        let zones = [];         // ê¸ˆì§€êµ¬ì—­ ëª©ë¡
        let isSettingMode = false;
        let isDrawing = false;
        let startX, startY, tempRect;

        /* [1] ê¸ˆì§€êµ¬ì—­ ì„¤ì • ëª¨ë“œ ì œì–´ */
        function toggleZoneSetup() {
            isSettingMode = !isSettingMode;
            const btn = document.getElementById('setup-btn');
            if (btn) {
                btn.innerText = isSettingMode ? "ğŸš« ê¸ˆì§€êµ¬ì—­ ì„¤ì •: ON" : "ğŸš« ê¸ˆì§€êµ¬ì—­ ì„¤ì •: OFF";
                btn.style.background = isSettingMode ? "#2ecc71" : "#e74c3c";
            }
        }

        /* [2] ë¡œë´‡ ìœ„ì¹˜ ì²´í¬ (ë°±ì—…ë³¸ í•µì‹¬ ê¸°ëŠ¥) */
        function isRobotInRect(left, top, width, height) {
            return currentRobots.some(r => {
                const rx = r.pose_x * 40; // ìŠ¤ì¼€ì¼ë§ ì ìš©
                const ry = r.pose_y * 40;
                return (rx >= left && rx <= left + width && ry >= top && ry <= top + height);
            });
        }

        /* [3] ë“œë¡œì‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ */
        /* [3] ë“œë¡œì‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ìˆ˜ì • */
        function startDraw(e) {
            // e.button === 0 ì´ ì™¼ìª½ í´ë¦­ì…ë‹ˆë‹¤. (1ì€ íœ , 2ëŠ” ìš°í´ë¦­)
            if (!isSettingMode || e.button !== 0) return; 
            
            isDrawing = true;
            const rect = e.currentTarget.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;

            tempRect = document.createElement('div');
            tempRect.className = 'temp-rect';
            tempRect.style.left = startX + 'px';
            tempRect.style.top = startY + 'px';
            e.currentTarget.appendChild(tempRect);
        }

        function doDraw(e) {
            if (!isDrawing) return;
            const rect = e.currentTarget.getBoundingClientRect();
            const curX = e.clientX - rect.left;
            const curY = e.clientY - rect.top;

            tempRect.style.width = Math.abs(curX - startX) + 'px';
            tempRect.style.height = Math.abs(curY - startY) + 'px';
            tempRect.style.left = Math.min(curX, startX) + 'px';
            tempRect.style.top = Math.min(curY, startY) + 'px';
        }

        function endDraw(e) {
            if (!isDrawing) return;
            isDrawing = false;
            
            const l = parseInt(tempRect.style.left);
            const t = parseInt(tempRect.style.top);
            const w = parseInt(tempRect.style.width);
            const h = parseInt(tempRect.style.height);

            // ë¡œë´‡ ì¶©ëŒ ê²€ì‚¬ ì‹¤í–‰
            if (isRobotInRect(l, t, w, h)) {
                alert("âš ï¸ ë¡œë´‡ì´ ìˆëŠ” ìœ„ì¹˜ì—ëŠ” ê¸ˆì§€êµ¬ì—­ì„ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
                tempRect.remove();
                return;
            }

            const reason = prompt("ê¸ˆì§€ êµ¬ì—­ ì„¤ì • ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”:", "ì‘ì—… êµ¬ì—­");
            if (reason) {
                zones.push({ id: Date.now(), left: l, top: t, width: w, height: h, reason: reason });
                renderZoneList();
            }
            tempRect.remove();
        }

        /* [4] UI ë Œë”ë§ (ì§€ë„ ë° ë¦¬ìŠ¤íŠ¸) */
        function renderZoneList() {
            const container = document.getElementById('zone-list-container');
            if (!container) return;
            
            // ë¦¬ìŠ¤íŠ¸ë§Œ ê°±ì‹  (ì§€ë„ëŠ” updateUIê°€ ë‹´ë‹¹)
            container.innerHTML = zones.length === 0 ? '<p style="color: #999;">ì„¤ì •ëœ êµ¬ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : 
                zones.map(z => `
                    <div class="zone-list-item" style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                        <span>ğŸš« <b>${z.reason}</b> (${z.left}, ${z.top})</span>
                        <button onclick="deleteZone(${z.id})" style="background:#ff4d4d; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">ì‚­ì œ</button>
                    </div>
                `).join('');
        }

        function deleteZone(id) {
            if (confirm("ì •ë§ ì´ êµ¬ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                zones = zones.filter(z => z.id !== id);
                renderZoneList();
            }
        }

        /* [5] ì‹¤ì‹œê°„ ë°ì´í„° ì—…ë°ì´íŠ¸ (í†µí•© ë¡œì§) */
        function updateUI() {
            // ë¡œë´‡ ë°ì´í„° (ì˜ˆì‹œ)
            currentRobots = [
                { "name": "R-01", "battery_level": 88, "pose_x": 4.5, "pose_y": 5.2 },
                { "name": "R-02", "battery_level": 20, "pose_x": 12.0, "pose_y": 3.0 }
            ];

            const mapInner = document.getElementById('map-inner');
            if (!mapInner) return;

            // 1. ë¡œë´‡ HTML ìƒì„±
            const robotHtml = currentRobots.map(r => `
                <div class="robot-dot" style="left:${r.pose_x * 40}px; top:${r.pose_y * 40}px; position:absolute;">
                    <div style="background:#3498db; width:30px; height:30px; border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-size:8px; border:2px solid #fff;">
                        <b>${r.name}</b><span>${r.battery_level}%</span>
                    </div>
                </div>
            `).join('');

            // 2. ê¸ˆì§€êµ¬ì—­ HTML ìƒì„± (í´ë¦­ ê¸°ëŠ¥ ì œê±°ë¨)
            const zoneHtml = zones.map(z => `
                <div class="no-go-zone" 
                    style="left:${z.left}px; top:${z.top}px; width:${z.width}px; height:${z.height}px;">
                    ${z.reason}
                </div>
            `).join('');

            // ì§€ë„ í•©ì¹˜ê¸°
            mapInner.innerHTML = robotHtml + zoneHtml;
            // í•˜ë‹¨ í…Œì´ë¸” ë°ì´í„° ìë™ ê°±ì‹ 
            refreshTableData();
        }

        function refreshTableData() {
            const vList = document.getElementById('visitor-list');
            const lList = document.getElementById('log-list');
            
            if (vList) {
                const visitors = [{ "res_date": "2026-03-04", "res_time": "15:29", "host_name": "í™ê¸¸ë™", "guest": "ê¹€ì² ìˆ˜" }];
                vList.innerHTML = visitors.map(v => `<tr><td>${v.res_date}</td><td>${v.res_time}</td><td>${v.host_name}</td><td>${v.guest}</td></tr>`).join('');
            }
            if (lList) {
                const logs = [{ "name": "R-01", "date": "2026-03-04", "time": "15:29:34", "state": "Start" }];
                lList.innerHTML = logs.map(l => `<tr><td>${l.date}</td><td>${l.time}</td><td>${l.name}</td><td>${l.state}</td></tr>`).join('');
            }
        }

        /* [6] ì´ˆê¸°í™” ë° íƒ­ ì œì–´ */
        function showTab(tabId) {
            // íƒ­ ì´ë™ ì‹œ ê¸ˆì§€êµ¬ì—­ ì„¤ì • ëª¨ë“œ ê°•ì œ ì¢…ë£Œ
            if (isSettingMode) {
                isSettingMode = false;
                const btn = document.getElementById('setup-btn');
                if (btn) {
                    btn.innerText = "ğŸš« ê¸ˆì§€êµ¬ì—­ ì„¤ì •: OFF";
                    btn.style.background = "#e74c3c";
                }
            }

            document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
            document.querySelectorAll('.sidebar-menu li').forEach(l => l.classList.remove('active'));
            
            const target = document.getElementById(tabId);
            if (target) target.style.display = 'block';
            document.getElementById('menu-' + tabId)?.classList.add('active');
            localStorage.setItem('activeTab', tabId);
        }

        function logout() {
            if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('activeTab');
                window.location.href = "/web";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const lastTab = localStorage.getItem('activeTab') || 'robot-mgmt';
            showTab(lastTab);
            setInterval(updateUI, 1000); // 1ì´ˆ ì£¼ê¸°ë¡œ ë°±ì—…ë³¸ì˜ ì‹¤ì‹œê°„ì„± ë³µêµ¬
        });
    </script>
</body>
</html>