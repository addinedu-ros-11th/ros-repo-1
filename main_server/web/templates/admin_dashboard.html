<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ê´€ì œ ì‹œìŠ¤í…œ</title>
    <style>
        /* [ê¸°ë³¸ ë ˆì´ì•„ì›ƒ] */
        body { display: flex; height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f4f9; }
        .sidebar { width: 250px; min-width: 250px; background: #2c3e50; color: white; display: flex; flex-direction: column; z-index: 100; }
        .sidebar h2 { padding: 20px; font-size: 1.2rem; border-bottom: 1px solid #34495e; margin: 0; }
        .sidebar-menu { list-style: none; padding: 0; flex-grow: 1; margin: 0; }
        .sidebar-menu li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #34495e; transition: 0.3s; }
        .sidebar-menu li.active { background: #3498db; }
        .logout-btn { padding: 15px 20px; background: #e74c3c; text-align: center; text-decoration: none; color: white; }

        .main-content { flex-grow: 1; padding: 30px; overflow-y: auto; min-width: 0; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* [ì§€ë„ ë° ë“œë˜ê·¸] */
        #map-container { 
            width: 100%; height: 500px; 
            background-color: #ffffff; 
            background-image: radial-gradient(#ddd 1px, transparent 1px); 
            background-size: 40px 40px; 
            border: 2px solid #adb5bd; border-radius: 12px; 
            position: relative; overflow: hidden; 
            box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
        }
        #map-container.drawing-mode { cursor: crosshair; }
        .btn-zone-setup { position: absolute; top: 15px; right: 15px; padding: 10px 20px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; z-index: 10; font-weight: bold; }
        
        #draw-rect { position: absolute; border: 2px dashed #e74c3c; background: rgba(231, 76, 60, 0.2); display: none; pointer-events: none; z-index: 8; }
        
        .no-go-zone { 
            position: absolute; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.3); 
            display: flex; align-items: center; justify-content: center; 
            color: #fff; font-weight: bold; font-size: 11px; z-index: 7; 
            text-align: center; overflow: hidden; padding: 2px;
        }
        .robot-dot { 
            position: absolute; width: 55px; height: 55px; 
            background-color: #3498db; border: 3px solid white; border-radius: 50%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: white; font-weight: bold; transform: translate(-50%, -50%); 
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1); z-index: 9; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .robot-dot .name { font-size: 11px; margin-bottom: 2px; }
        .robot-dot .battery { font-size: 13px; }

        /* [ê¸ˆì§€êµ¬ì—­ ê´€ë¦¬ ì„¹ì…˜] */
        .management-section { margin-top: 30px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .zone-form { display: flex; gap: 20px; align-items: center; margin-bottom: 20px; padding: 0 20px; background: #f8f9fa; border-radius: 8px; border: 1px solid #ddd; height: 80px; }
        .zone-info-box { min-width: 250px; max-width: 250px; display: flex; flex-direction: column; justify-content: center; }
        #temp-coord { display: block; font-size: 0.9rem; line-height: 1.4; color: #e67e22; font-weight: bold; }
        .zone-form input { height: 35px; padding: 0 10px; border: 1px solid #ddd; border-radius: 4px; flex-grow: 1; }
        
        /* [ê³µí†µ ë°ì´í„° í…Œì´ë¸”] */
        .data-table { width: 100%; border-collapse: collapse; background: white; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px; border: 1px solid #ccc; text-align: center; }
        .data-table th { background: #34495e; color: white; }
        .btn-action { height: 40px; min-width: 90px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-save { background: #2ecc71; color: white; }
        .btn-cancel { background: #95a5a6; color: white; }
        .btn-delete { background: #e74c3c; color: white; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>ê´€ë¦¬ì ë©”ë‰´</h2>
        <ul class="sidebar-menu">
            <li id="menu-robot-mgmt" onclick="showTab('robot-mgmt')">ğŸ¤– ë¡œë´‡ ê´€ë¦¬</li>
            <li id="menu-visitor-res" onclick="showTab('visitor-res')">ğŸ“… ë°©ë¬¸ê° ì˜ˆì•½ í˜„í™©</li>
            <li id="menu-sys-logs" onclick="showTab('sys-logs')">ğŸ“œ ì‹œìŠ¤í…œ ë™ì‘ ë¡œê·¸</li>
        </ul>
        <a href="/web" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
    </div>

    <div class="main-content">
        <div id="robot-mgmt" class="tab-content">
            <h1>ğŸ¤– ë¡œë´‡ ì‹¤ì‹œê°„ ê´€ì œ</h1>
            <div id="map-container" onmousedown="startDraw(event)" onmousemove="doDraw(event)" onmouseup="endDraw(event)">
                <button class="btn-zone-setup" id="setup-btn" onclick="toggleSetupMode()">ê¸ˆì§€êµ¬ì—­ì„¤ì •</button>
                <div id="draw-rect"></div>
                <div id="map-inner"></div>
            </div>

            <div class="management-section">
                <h2>ğŸš« ê¸ˆì§€êµ¬ì—­ ê´€ë¦¬</h2>
                <div id="new-zone-form" class="zone-form">
                    <div class="zone-info-box">
                        <strong style="color:#333;">[ì‹ ê·œ êµ¬ì—­ ë“±ë¡]</strong>
                        <span id="temp-coord"></span>
                    </div>
                    <input type="text" id="temp-reason" placeholder="ê¸ˆì§€ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <button class="btn-action btn-save" onclick="confirmAddZone()">ì €ì¥í•˜ê¸°</button>
                    <button class="btn-action btn-cancel" onclick="clearTempZone()">ì·¨ì†Œ</button>
                </div>

                <table class="data-table">
                    <thead>
                        <tr><th>êµ¬ì—­ ID</th><th>ìœ„ì¹˜ ë° í¬ê¸°</th><th>ê¸ˆì§€ ì‚¬ìœ </th><th>ê´€ë¦¬</th></tr>
                    </thead>
                    <tbody id="zone-list"></tbody>
                </table>
            </div>
        </div>

        <div id="visitor-res" class="tab-content">
            <h1>ğŸ“… ë°©ë¬¸ê° ì˜ˆì•½ í˜„í™©</h1>
            <table class="data-table">
                <thead>
                    <tr><th>ì˜ˆì•½ ë‚ ì§œ</th><th>ì‹œê°„</th><th>í˜¸ìŠ¤íŠ¸</th><th>ë°©ë¬¸ê°</th></tr>
                </thead>
                <tbody id="visitor-list"></tbody>
            </table>
        </div>

        <div id="sys-logs" class="tab-content">
            <h1>ğŸ“œ ì‹œìŠ¤í…œ ë™ì‘ ë¡œê·¸</h1>
            <table class="data-table">
                <thead>
                    <tr><th>ë‚ ì§œ</th><th>ì‹œê°„</th><th>ë¡œë´‡ëª…</th><th>ì‘ì—… ID</th><th>ë°°í„°ë¦¬</th><th>ìƒíƒœ</th></tr>
                </thead>
                <tbody id="log-list"></tbody>
            </table>
        </div>
    </div>

<script>
    let isSetupMode = false, isDrawing = false, startX, startY, tempZone = null, zones = [], currentRobots = [];

    // [íƒ­ ì „í™˜ í•¨ìˆ˜]
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.sidebar-menu li').forEach(l => l.classList.remove('active'));
        const targetTab = document.getElementById(tabId);
        const targetMenu = document.getElementById('menu-' + tabId);
        if(targetTab && targetMenu) {
            targetTab.classList.add('active');
            targetMenu.classList.add('active');
            localStorage.setItem('activeTab', tabId);
        }
    }

    // [ê¸ˆì§€êµ¬ì—­ ì„¤ì • ê´€ë ¨ í•¨ìˆ˜]
    function toggleSetupMode() {
        isSetupMode = !isSetupMode;
        const btn = document.getElementById('setup-btn');
        const map = document.getElementById('map-container');
        btn.classList.toggle('active', isSetupMode);
        map.classList.toggle('drawing-mode', isSetupMode);
        btn.innerText = isSetupMode ? "ì˜ì—­ ë“œë˜ê·¸ ì¤‘..." : "ê¸ˆì§€êµ¬ì—­ì„¤ì •";
    }

    function startDraw(e) {
        if (!isSetupMode) return;
        isDrawing = true;
        const rect = e.currentTarget.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        const drawRect = document.getElementById('draw-rect');
        Object.assign(drawRect.style, { left: `${startX}px`, top: `${startY}px`, width: '0px', height: '0px', display: 'block' });
    }

    function doDraw(e) {
        if (!isDrawing) return;
        const rect = e.currentTarget.getBoundingClientRect();
        const curX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
        const curY = Math.max(0, Math.min(e.clientY - rect.top, rect.height));
        const drawRect = document.getElementById('draw-rect');
        drawRect.style.width = Math.abs(curX - startX) + 'px';
        drawRect.style.height = Math.abs(curY - startY) + 'px';
        drawRect.style.left = Math.min(curX, startX) + 'px';
        drawRect.style.top = Math.min(curY, startY) + 'px';
    }

    function endDraw() {
        if (!isDrawing) return;
        isDrawing = false;
        const drawRect = document.getElementById('draw-rect');
        tempZone = {
            left: parseInt(drawRect.style.left),
            top: parseInt(drawRect.style.top),
            width: parseInt(drawRect.style.width),
            height: parseInt(drawRect.style.height)
        };
        if (tempZone.width > 5) {
            document.getElementById('temp-coord').innerHTML = `ìœ„ì¹˜: (${tempZone.left}, ${tempZone.top})<br>í¬ê¸°: ${tempZone.width}x${tempZone.height}`;
        }
        toggleSetupMode();
    }

    function clearTempZone() {
        tempZone = null;
        document.getElementById('temp-coord').innerHTML = "";
        document.getElementById('temp-reason').value = "";
        document.getElementById('draw-rect').style.display = 'none';
    }

    function confirmAddZone() {
        if (!tempZone) { alert("ì˜ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        const reason = document.getElementById('temp-reason').value;
        if (!reason) { alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

        const isRobotInside = currentRobots.some(r => {
            const rx = r.pose_x * 40; const ry = r.pose_y * 40;
            return (rx >= tempZone.left && rx <= tempZone.left + tempZone.width &&
                    ry >= tempZone.top && ry <= tempZone.top + tempZone.height);
        });

        if (isRobotInside) { alert("âš ï¸ ë¡œë´‡ì´ ìˆëŠ” ìœ„ì¹˜ì—ëŠ” ê¸ˆì§€êµ¬ì—­ì„ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); clearTempZone(); return; }

        zones.push({ ...tempZone, id: Date.now(), reason: reason });
        clearTempZone();
        renderZones();
    }

    function renderZones() {
        const zoneList = document.getElementById('zone-list');
        zoneList.innerHTML = zones.map(z => `
            <tr>
                <td>#${z.id.toString().slice(-4)}</td>
                <td>(${z.left},${z.top}) ${z.width}x${z.height}</td>
                <td>${z.reason}</td>
                <td><button class="btn-delete" onclick="deleteZone(${z.id})">ì‚­ì œ</button></td>
            </tr>
        `).join('');
    }

    function deleteZone(id) {
        if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            zones = zones.filter(z => z.id !== id);
            renderZones();
        }
    }

    // [ì „ì²´ UI ì—…ë°ì´íŠ¸ ë° ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜]
    function updateUI() {
        // 1. ë¡œë´‡ ë°ì´í„° ì—…ë°ì´íŠ¸
        currentRobots = [
            { "name": "R-01", "battery_level": 88, "pose_x": 4.0 + Math.random()*0.5, "pose_y": 6.0 + Math.random()*0.5 },
            { "name": "R-02", "battery_level": 15, "pose_x": 10.0 + Math.random()*0.5, "pose_y": 3.0 + Math.random()*0.5 }
        ];

        const mapInner = document.getElementById('map-inner');
        const robotHtml = currentRobots.map(r => `
            <div class="robot-dot" style="left:${r.pose_x * 40}px; top:${r.pose_y * 40}px;">
                <div class="name">${r.name}</div>
                <div class="battery">${r.battery_level}%</div>
            </div>
        `).join('');
        
        const zoneHtml = zones.map(z => `
            <div class="no-go-zone" style="left:${z.left}px; top:${z.top}px; width:${z.width}px; height:${z.height}px;">
                ${z.reason}
            </div>
        `).join('');
        mapInner.innerHTML = robotHtml + zoneHtml;

        // 2. ë°©ë¬¸ê° ì˜ˆì•½ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì—…ë¡œë“œ íŒŒì¼ ê¸°ì¤€)
        const mockVisitors = [
            { "res_date": "2026-03-04", "res_time": "15:29", "host_name": "í™ê¸¸ë™", "guest": "ê¹€ì² ìˆ˜" }
        ];
        document.getElementById('visitor-list').innerHTML = mockVisitors.map(v => `
            <tr><td>${v.res_date}</td><td>${v.res_time}</td><td>${v.host_name}</td><td>${v.guest}</td></tr>
        `).join('');

        // 3. ì‹œìŠ¤í…œ ë¡œê·¸ ë°ì´í„° ì—…ë°ì´íŠ¸ (ì—…ë¡œë“œ íŒŒì¼ ê¸°ì¤€)
        const mockLogs = [
            { "name": "R-01", "battery_level": 90, "current_task_id": 123, "date": "2026-03-04", "time": "15:29:34", "state": "Start" }
        ];
        document.getElementById('log-list').innerHTML = mockLogs.map(l => `
            <tr><td>${l.date}</td><td>${l.time}</td><td>${l.name}</td><td>#${l.current_task_id}</td><td>${l.battery_level}%</td><td>${l.state}</td></tr>
        `).join('');
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTab = localStorage.getItem('activeTab') || 'robot-mgmt';
        showTab(savedTab);
        renderZones();
        updateUI();
        setInterval(updateUI, 2000); 
    });
</script>
</body>
</html>